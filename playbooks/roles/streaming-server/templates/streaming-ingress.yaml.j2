# playbooks/roles/streaming-server/templates/streaming-ingress.yaml.j2
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: {{ app_name }}-ingress
  namespace: {{ app_namespace }}
  labels:
    app: {{ app_name }}
    environment: {{ deployment_environment | default('production') }}
    created-by: ansible
    ingress-type: neg-only
  annotations:
    # GCP-specific annotations - NO global IP to avoid conflict
    kubernetes.io/ingress.class: "gce"

    # Enable NEG (Network Endpoint Groups) for better load balancing
    cloud.google.com/neg: '{"ingress": true}'

    # Backend configuration for health checks and timeouts
    cloud.google.com/backend-config: '{"default": "{{ project_name }}-backend-config"}'

    # Allow HTTP traffic
    kubernetes.io/ingress.allow-http: "true"

    # Ingress optimization annotations
    nginx.ingress.kubernetes.io/proxy-body-size: "100m"
    nginx.ingress.kubernetes.io/proxy-read-timeout: "300"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "300"

spec:
  rules:
    # Default rule for all hosts (geographic routing)
    - http:
        paths:
          # Root path - Main page
          - path: /
            pathType: Prefix
            backend:
              service:
                name: {{ app_name }}
                port:
                  number: {{ app_http_port | default('80') | int }}

          # Health endpoint - Exact match for load balancer health checks
          - path: /health
            pathType: Exact
            backend:
              service:
                name: {{ app_name }}
                port:
                  number: {{ app_http_port | default('80') | int }}

          # Metrics endpoint - Exact match for monitoring
          - path: /metrics
            pathType: Exact
            backend:
              service:
                name: {{ app_name }}
                port:
                  number: {{ metrics_port | default('9090') | int }}

          # HLS streaming endpoint - Prefix for all HLS files (.m3u8, .ts)
          - path: /hls
            pathType: Prefix
            backend:
              service:
                name: {{ app_name }}
                port:
                  number: {{ app_http_port | default('80') | int }}

          # Video files endpoint - Prefix for video storage
          - path: /videos
            pathType: Prefix
            backend:
              service:
                name: {{ app_name }}
                port:
                  number: {{ app_http_port | default('80') | int }}

          # Live streaming page - Prefix for live streaming interface
          - path: /live
            pathType: Prefix
            backend:
              service:
                name: {{ app_name }}
                port:
                  number: {{ app_http_port | default('80') | int }}

          # Static files endpoint - Prefix for general file serving
          - path: /files
            pathType: Prefix
            backend:
              service:
                name: {{ app_name }}
                port:
                  number: {{ app_http_port | default('80') | int }}

{% if domain_name is defined and domain_name != "" %}
    # Domain-specific rule (if domain is configured)
    - host: {{ domain_name }}
      http:
        paths:
          # Root path
          - path: /
            pathType: Prefix
            backend:
              service:
                name: {{ app_name }}
                port:
                  number: {{ app_http_port | default('80') | int }}

          # Health endpoint
          - path: /health
            pathType: Exact
            backend:
              service:
                name: {{ app_name }}
                port:
                  number: {{ app_http_port | default('80') | int }}

          # Metrics endpoint
          - path: /metrics
            pathType: Exact
            backend:
              service:
                name: {{ app_name }}
                port:
                  number: {{ metrics_port | default('9090') | int }}

          # HLS streaming
          - path: /hls
            pathType: Prefix
            backend:
              service:
                name: {{ app_name }}
                port:
                  number: {{ app_http_port | default('80') | int }}

          # Video files
          - path: /videos
            pathType: Prefix
            backend:
              service:
                name: {{ app_name }}
                port:
                  number: {{ app_http_port | default('80') | int }}

          # Live streaming page
          - path: /live
            pathType: Prefix
            backend:
              service:
                name: {{ app_name }}
                port:
                  number: {{ app_http_port | default('80') | int }}

          # Static files
          - path: /files
            pathType: Prefix
            backend:
              service:
                name: {{ app_name }}
                port:
                  number: {{ app_http_port | default('80') | int }}

    # WWW subdomain (if domain is configured)
    - host: www.{{ domain_name }}
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: {{ app_name }}
                port:
                  number: {{ app_http_port | default('80') | int }}
{% endif %}