# playbooks/roles/streaming-server/templates/streaming-ingress.yaml.j2
apiVersion: v1
kind: Secret
metadata:
  name: basic-auth-secret
  namespace: {{ app_namespace }}
type: Opaque
data:
  # Generate with: htpasswd -c auth admin
  # Then: cat auth | base64 -w 0
  auth: {{ basic_auth_hash  }}
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: {{ app_name }}-ingress
  namespace: {{ app_namespace }}
  labels:
    app: {{ app_name }}
    environment: {{ deployment_environment | default('production') }}
    created-by: ansible
    ingress-type: auth-enabled
  annotations:
    kubernetes.io/ingress.class: "gce"
    cloud.google.com/neg: '{"ingress": true}'
    cloud.google.com/backend-config: '{"default": "{{ project_name }}-backend-config"}'

    # Basic Auth for protected paths
    nginx.ingress.kubernetes.io/auth-type: basic
    nginx.ingress.kubernetes.io/auth-secret: basic-auth-secret
    nginx.ingress.kubernetes.io/auth-realm: 'Authentication Required - {{ app_name }}'

    # Server snippet to disable auth for public endpoints
    nginx.ingress.kubernetes.io/server-snippet: |
      location /health {
        auth_basic off;
      }
      location /hls {
        auth_basic off;
      }
      location /metrics {
        auth_basic off;
      }
spec:
  rules:
    # Default rule - works for any domain/IP
    - http:
        paths:
          # Public paths (no auth required)
          - path: /health
            pathType: Exact
            backend:
              service:
                name: {{ app_name }}
                port:
                  number: {{ app_http_port | default('80') | int }}

          - path: /hls
            pathType: Prefix
            backend:
              service:
                name: {{ app_name }}
                port:
                  number: {{ app_http_port | default('80') | int }}

          - path: /metrics
            pathType: Exact
            backend:
              service:
                name: {{ app_name }}
                port:
                  number: {{ metrics_port | default('9090') | int }}

          # Protected paths (require basic auth)
          - path: /videos
            pathType: Prefix
            backend:
              service:
                name: {{ app_name }}
                port:
                  number: {{ app_http_port | default('80') | int }}

          - path: /admin
            pathType: Prefix
            backend:
              service:
                name: {{ app_name }}
                port:
                  number: {{ app_http_port | default('80') | int }}

          - path: /files
            pathType: Prefix
            backend:
              service:
                name: {{ app_name }}
                port:
                  number: {{ app_http_port | default('80') | int }}

          - path: /live
            pathType: Prefix
            backend:
              service:
                name: {{ app_name }}
                port:
                  number: {{ app_http_port | default('80') | int }}

          # Root path (protected)
          - path: /
            pathType: Prefix
            backend:
              service:
                name: {{ app_name }}
                port:
                  number: {{ app_http_port | default('80') | int }}