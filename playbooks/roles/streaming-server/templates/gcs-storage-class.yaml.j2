# GCS FUSE CSI StorageClass for regional content access
# File: playbooks/roles/streaming-server/templates/gcs-storage-class.yaml.j2
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: gcs-fuse-{{ bastion_region }}
  labels:
    app: {{ app_name }}
    region: {{ bastion_region }}
    storage-type: gcs-fuse
provisioner: gcs-fuse.csi.storage.gke.io
allowVolumeExpansion: false
volumeBindingMode: Immediate
parameters:
  # Use regional bucket for this region
  bucketName: "{{ regional_bucket_names[bastion_region] }}"

  # Mount options for optimal performance
  mountOptions: "implicit-dirs,uid=101,gid=101,file-mode=644,dir-mode=755"

  # Cache settings for better performance
  metadataStatCacheCapacity: "32768"
  typeCacheMaxSizeMB: "1024"

  # Read-only access for streaming content
  readOnly: "true"

  # Optional: Enable file caching for frequently accessed files
  fileCacheCapacity: "1000"

  # GCP service account for bucket access (via Workload Identity)
  serviceAccount: "{{ content_reader_sa_email }}"

# Additional annotations for monitoring and management
metadata:
  annotations:
    storageclass.kubernetes.io/is-default-class: "false"
    description: "GCS FUSE storage class for {{ bastion_region }} regional content"
    bucket-region: "{{ bastion_region }}"
    content-type: "streaming-videos"