apiVersion: v1
kind: Service
metadata:
  name: {{ app_name }}
  namespace: {{ app_namespace }}
  annotations:
    cloud.google.com/backend-config: '{"default": "{{ project_name }}-backend-config"}'
    cloud.google.com/neg: '{{ cloud_neg | default('{"ingress": true}') }}'
    prometheus.io/scrape: "{{ prometheus_scrape | default('true') }}"
    prometheus.io/port: "{{ metrics_port | default('9090') }}"
{% if extra_annotations is defined %}
{% for key, value in extra_annotations.items() %}
    {{ key }}: "{{ value }}"
{% endfor %}
{% endif %}
spec:
  type: {{ service_type | default('NodePort') }}
  selector:
    app: {{ app_name }}
  ports:
    - port: {{ app_http_port | default('80') }}
      targetPort: {{ app_http_port | default('80') }}
      protocol: TCP
      name: http
{% if expose_rtmp | default(true) %}
    - port: {{ app_rtmp_port | default('1935') }}
      targetPort: {{ app_rtmp_port | default('1935') }}
      protocol: TCP
      name: rtmp
{% endif %}
    - port: {{ metrics_port | default('9090') }}
      targetPort: {{ metrics_port | default('9090') }}
      protocol: TCP
      name: metrics
{% if extra_ports is defined %}
{% for port in extra_ports %}
    - port: {{ port.port }}
      targetPort: {{ port.targetPort | default(port.port) }}
      protocol: {{ port.protocol | default('TCP') }}
      name: {{ port.name }}
{% endfor %}
{% endif %}