---
# Deploy Service for HLS streaming
# File: playbooks/roles/streaming-server/tasks/deploy-service.yml

- name: Create HLS streaming service
  k8s:
    state: present
    definition:
      apiVersion: v1
      kind: Service
      metadata:
        name: "{{ app_name }}"
        namespace: "{{ app_namespace }}"
        annotations:
          cloud.google.com/backend-config: '{"default": "{{ project_name }}-backend-config"}'
          cloud.google.com/neg: '{{ cloud_neg | default('{"ingress": true}') }}'
          prometheus.io/scrape: "{{ prometheus_scrape | default('true') }}"
          prometheus.io/port: "{{ metrics_port | default('9090') }}"
          prometheus.io/path: "/metrics"
        labels:
          app: "{{ app_name }}"
          environment: "{{ deployment_environment | default('production') }}"
          streaming-type: "hls"
      spec:
        type: "{{ service_type | default('NodePort') }}"
        selector:
          app: "{{ app_name }}"
        ports:
          - port: "{{ app_http_port | default('80') | int }}"
            targetPort: "{{ app_http_port | default('80') | int }}"
            protocol: TCP
            name: http
          - port: "{{ app_https_port | default('443') | int }}"
            targetPort: "{{ app_https_port | default('443') | int }}"
            protocol: TCP
            name: https
          - port: "{{ metrics_port | default('9090') | int }}"
            targetPort: "{{ metrics_port | default('9090') | int }}"
            protocol: TCP
            name: metrics
    wait: true
    wait_timeout: 60

- name: Get service status
  k8s_info:
    api_version: v1
    kind: Service
    name: "{{ app_name }}"
    namespace: "{{ app_namespace }}"
  register: service_status

- name: Display service status
  debug:
    msg: "Service {{ app_name }} created with {{ service_status.resources[0].spec.ports | length }} ports"

- name: Get service endpoints
  k8s_info:
    api_version: v1
    kind: Endpoints
    name: "{{ app_name }}"
    namespace: "{{ app_namespace }}"
  register: endpoints_status

- name: Display endpoints status
  debug:
    msg: "Service endpoints: {{ endpoints_status.resources[0].subsets | default([]) | length }} endpoint subsets"