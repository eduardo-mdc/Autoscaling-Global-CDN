- name: Get current region from bastion hostname
  shell: "hostname | grep -o 'bastion-[a-z0-9-]*' | cut -d'-' -f2-"
  register: current_region

- name: Display current region for CSI driver check
  debug:
    msg: "ðŸ”§ Waiting for GCS FUSE CSI driver in region: {{ current_region.stdout }} (enabled via Terraform)"

- name: Wait for CSI driver to be available
  shell: "kubectl get csidriver gcs-fuse.csi.storage.gke.io --ignore-not-found"
  register: csi_driver_check
  until: csi_driver_check.stdout != ""
  retries: 60
  delay: 10
  changed_when: false

- name: Wait for CSI driver pods to be running
  shell: |
    kubectl get pods -n gcs-fuse-csi-driver --field-selector=status.phase=Running --no-headers | wc -l
  register: csi_pods_running
  until: csi_pods_running.stdout | int > 0
  retries: 30
  delay: 10
  changed_when: false

- name: Display CSI driver status
  debug:
    msg: |
      âœ… GCS FUSE CSI Driver Ready!
      
      ðŸ“‹ Status:
      - CSI Driver: FOUND
      - Running Pods: {{ csi_pods_running.stdout }}
      
      ðŸŽ¯ Ready to deploy storage components